<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Leave Details - Medscred HRMS</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/favicon.png') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <style>
        body {
            background: linear-gradient(135deg, #f8fbff 0%, #e3f2fd 50%, #bbdefb 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #1565c0;
        }
        
        .navbar {
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 0 4px 20px rgba(21,101,192, 0.15);
            border-bottom: 3px solid #2196f3;
            padding: 0.8rem 0;
        }
        
        .navbar-brand {
            font-weight: 700;
            color: #0d47a1 !important;
            font-size: 1.3rem;
        }
        
        .btn-outline-primary {
            border-color: #2196f3;
            color: #1976d2;
            font-weight: 600;
            transition: all 0.3s ease;
            border-width: 2px;
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }
        
        .btn-outline-primary:hover {
            background: #2196f3;
            border-color: #1976d2;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(33,150,243,0.3);
        }
        
        .details-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        .details-card {
            background: white;
            border-radius: 1.2rem;
            box-shadow: 0 12px 35px rgba(21,101,192,0.1);
            border: 2px solid #2196f3;
            overflow: hidden;
            margin-bottom: 2rem;
        }
        
        .card-header {
            background: linear-gradient(135deg, #2196f3, #1565c0);
            color: white;
            font-weight: 700;
            font-size: 1.4rem;
            padding: 1.5rem;
        }
        
        .info-row {
            padding: 1rem 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 600;
            color: #1565c0;
            margin-bottom: 0.5rem;
        }
        
        .info-value {
            color: #333;
        }
        
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 0.6rem;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status-approved {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-rejected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .btn-back {
            background: #6c757d;
            border: none;
            color: white;
            padding: 0.6rem 1.5rem;
            border-radius: 0.5rem;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
        }
        
        .btn-back:hover {
            background: #5a6268;
            color: white;
            text-decoration: none;
            transform: translateY(-1px);
        }
        
        @media (max-width: 768px) {
            .details-container {
                margin: 1rem auto;
                padding: 0 0.5rem;
            }
            
            .details-card {
                margin-bottom: 1rem;
            }
            
            .card-header {
                padding: 1.2rem 1rem;
                font-size: 1.2rem;
            }
            
            .info-row {
                padding: 0.8rem 0;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand navbar-light shadow-sm">
        <div class="container">
            <span class="navbar-brand">Leave Details</span>
            <div class="ms-auto">
                <a href="{{ url_for('admin_leaves') }}" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left me-1"></i> Back to Leaves
                </a>
            </div>
        </div>
    </nav>

    <div class="details-container">
        <a href="{{ url_for('admin_leaves') }}" class="btn-back">
            <i class="bi bi-arrow-left me-1"></i> Back to Leave Management
        </a>
        
        <div class="details-card">
            <div class="card-header">
                <i class="bi bi-file-earmark-text me-2"></i>Leave Application Details
            </div>
            <div class="card-body p-4">
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-row">
                            <div class="info-label">Employee Name</div>
                            <div class="info-value">{{ leave.firstname }} {{ leave.lastname }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Designation</div>
                            <div class="info-value">{{ leave.designation }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Email</div>
                            <div class="info-value">{{ leave.email }}</div>
                        </div>
                        {% if leave.phone %}
                        <div class="info-row">
                            <div class="info-label">Phone</div>
                            <div class="info-value">{{ leave.phone }}</div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <div class="info-row">
                            <div class="info-label">Leave Type</div>
                            <div class="info-value">
                                <span class="badge bg-info">{{ leave.leave_type.replace('_', ' ').title() }}</span>
                            </div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Leave Period</div>
                            <div class="info-value">
                                <strong>{{ leave.start_date.strftime('%d %B %Y') }}</strong>
                                {% if leave.start_date != leave.end_date %}
                                to <strong>{{ leave.end_date.strftime('%d %B %Y') }}</strong>
                                {% endif %}
                                {% if leave.half_day %}
                                <br><span class="badge bg-warning text-dark">
                                    {{ leave.half_day_period.replace('_', ' ').title() if leave.half_day_period else 'Half Day' }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Total Days</div>
                            <div class="info-value"><strong>{{ leave.total_days }}</strong> day{{ 's' if leave.total_days != 1 else '' }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Applied Date</div>
                            <div class="info-value">{{ leave.applied_date.strftime('%d %B %Y at %I:%M %p') }}</div>
                        </div>
                    </div>
                </div>
                
                <div class="info-row">
                    <div class="info-label">Reason for Leave</div>
                    <div class="info-value">{{ leave.reason }}</div>
                </div>
                
                {% if leave.emergency_contact %}
                <div class="info-row">
                    <div class="info-label">Emergency Contact</div>
                    <div class="info-value">{{ leave.emergency_contact }}</div>
                </div>
                {% endif %}
                
                <div class="info-row">
                    <div class="info-label">Status</div>
                    <div class="info-value">
                        <span class="status-badge status-{{ leave.status }}">
                            <i class="bi bi-{{ 'clock' if leave.status == 'pending' else 'check-circle' if leave.status == 'approved' else 'x-circle' }} me-1"></i>
                            {{ leave.status.title() }}
                        </span>
                    </div>
                </div>
                
                {% if leave.approved_by_fname and leave.approved_by_lname %}
                <div class="info-row">
                    <div class="info-label">{{ 'Approved' if leave.status == 'approved' else 'Rejected' }} By</div>
                    <div class="info-value">
                        {{ leave.approved_by_fname }} {{ leave.approved_by_lname }}
                        {% if leave.approved_date %}
                        <br><small class="text-muted">on {{ leave.approved_date.strftime('%d %B %Y at %I:%M %p') }}</small>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                {% if leave.admin_comments %}
                <div class="info-row">
                    <div class="info-label">Admin Comments</div>
                    <div class="info-value alert alert-info">
                        <i class="bi bi-chat-square-text me-2"></i>{{ leave.admin_comments }}
                    </div>
                </div>
                {% endif %}
                
                <!-- Action Buttons for Pending Leaves -->
                {% if leave.status == 'pending' %}
                <div class="text-center mt-4">
                    <button type="button" class="btn btn-success me-2" 
                            data-leave-id="{{ leave.id }}" 
                            data-action="approve" 
                            data-employee-name="{{ leave.firstname }} {{ leave.lastname }}"
                            onclick="showApprovalModal(this.dataset.leaveId, this.dataset.action, this.dataset.employeeName)">
                        <i class="bi bi-check-circle me-2"></i>Approve Leave
                    </button>
                    <button type="button" class="btn btn-danger"
                            data-leave-id="{{ leave.id }}" 
                            data-action="reject" 
                            data-employee-name="{{ leave.firstname }} {{ leave.lastname }}"
                            onclick="showApprovalModal(this.dataset.leaveId, this.dataset.action, this.dataset.employeeName)">
                        <i class="bi bi-x-circle me-2"></i>Reject Leave
                    </button>
                </div>
                {% endif %}

            </div>
        </div>
    </div>

    <!-- Approval/Rejection Modal -->
    <div class="modal fade" id="approvalModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Approve Leave</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" id="approvalForm">
                    <div class="modal-body">
                        <input type="hidden" name="action" id="modalAction">
                        <p id="modalText">Are you sure you want to approve this leave application?</p>
                        <div class="mb-3">
                            <label for="admin_comments" class="form-label fw-bold">Comments for Employee:</label>
                            <textarea class="form-control" id="admin_comments" name="admin_comments" rows="3"
                                      placeholder="Add any remarks or comments that will be visible to the employee..."></textarea>
                            <small class="form-text text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                These comments will be visible to the employee in their leave history.
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x me-1"></i>Cancel
                        </button>
                        <button type="submit" class="btn" id="modalSubmitBtn">
                            <i class="bi bi-check me-1"></i>Approve
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Main JavaScript -->
    <script>
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing JavaScript...');
            
            // Test Bootstrap modal availability
            if (typeof bootstrap === 'undefined') {
                console.error('Bootstrap is not loaded!');
                alert('Bootstrap JavaScript is not loaded. Please refresh the page.');
                return;
            }
            
            console.log('Bootstrap loaded successfully');
            console.log('showApprovalModal function loaded:', typeof showApprovalModal);
        });
        
        function showApprovalModal(leaveId, action, employeeName) {
            console.log('showApprovalModal called with:', leaveId, action, employeeName);
            
            try {
                // Get modal element
                const modalElement = document.getElementById('approvalModal');
                if (!modalElement) {
                    throw new Error('Modal element not found');
                }
                
                // Initialize Bootstrap modal
                const modal = new bootstrap.Modal(modalElement);
                
                // Get form elements
                const form = document.getElementById('approvalForm');
                const title = document.getElementById('modalTitle');
                const text = document.getElementById('modalText');
                const submitBtn = document.getElementById('modalSubmitBtn');
                const actionInput = document.getElementById('modalAction');
                const commentsField = document.getElementById('admin_comments');
                
                // Verify all elements exist
                if (!form || !title || !text || !submitBtn || !actionInput || !commentsField) {
                    throw new Error('One or more modal elements not found');
                }
                
                // Clear previous comments
                commentsField.value = '';
                
                // Set form action URL
                form.action = `/approve_leave/${leaveId}`;
                actionInput.value = action;
                
                console.log(`Form action set to: ${form.action}`);
                console.log(`Action input set to: ${actionInput.value}`);
                
                // Update modal content based on action
                if (action === 'approve') {
                    title.innerHTML = '<i class="bi bi-check-circle me-2"></i>Approve Leave Application';
                    text.innerHTML = `<i class="bi bi-question-circle me-2"></i>Are you sure you want to <strong class="text-success">approve</strong> <strong>${employeeName}'s</strong> leave application?`;
                    submitBtn.innerHTML = '<i class="bi bi-check me-1"></i>Approve';
                    submitBtn.className = 'btn btn-success';
                } else if (action === 'reject') {
                    title.innerHTML = '<i class="bi bi-x-circle me-2"></i>Reject Leave Application';
                    text.innerHTML = `<i class="bi bi-question-circle me-2"></i>Are you sure you want to <strong class="text-danger">reject</strong> <strong>${employeeName}'s</strong> leave application?`;
                    submitBtn.innerHTML = '<i class="bi bi-x me-1"></i>Reject';
                    submitBtn.className = 'btn btn-danger';
                } else {
                    throw new Error(`Invalid action: ${action}`);
                }
                
                console.log('Modal content updated, showing modal...');
                
                // Show the modal
                modal.show();
                
                console.log('Modal should now be visible');
                
            } catch (error) {
                console.error('Error in showApprovalModal:', error);
                alert('Error opening approval modal: ' + error.message);
            }
        }
        
        // Test function to verify everything is working
        function testModal() {
            console.log('Testing modal functionality...');
            showApprovalModal(1, 'approve', 'Test User');
        }
        
        // Add test button click handler (for debugging)
        console.log('JavaScript loaded successfully');
    </script>
</body>
</html>
